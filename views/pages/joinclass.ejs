<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="/css/home.css" />
    <title>Join Class</title>
</head>
<body>
    <!-- navbar -->
    <%- include('../includes/navbar.ejs')%>

    <!-- main -->
    <main>
        <div class="container">
            <!-- left -->
            <%- include('../includes/sidebar.ejs')%>
            <!-- middle -->
            <div class="middle">
                <div class="joinclass">

                  <!-- <div class="profile">
                    <img src="/img/boy.png" alt="profiletutor" />
                  </div>
                  <div class="head-detial-post">
                    <p id="tutorname">Tutor: </p>
                    <div class="icon">
                      <i class="fa-regular fa-star"></i>
                      <span>5</span>
                    </div>
                    <div class="btn-joinclass">
                      <button class="btn-join" id="btn-join">JOIN</button>
                    </div>
                  </div>
                  <div class="detail-joinclass">
                    <p id="tag">Tag :</p>
                    <p id="location">Location :</p>
                    <p id="date">Date :</p>
                    <p id="price">Price :</p>
                    <p id="amount">จำนวนคนที่รับ :</p>
                    <p id="hours">จำนวนชั่วโมงที่เรียน :</p>
                  </div>
                  <div id="popup">
                    <p>Join successfully!</p>
                  </div> -->


                    <div class="profile">
                        <img src="" alt="profiletutor" id="profilePic">
                    </div>
                    <div class="head-detial-post">
                        <p id="tutorName">Tutor :</p>
                        <div class="icon">
                            <i class="fa-regular fa-star"></i>
                            <span>5</span>
                        </div>
                        <div class="btn-joinclass">
                          <button class="btn-join" id="joinButton">JOIN</button>
                        </div>
                    </div>
                    <div class="detail-joinclass">
                        <p id="tag">Tag &nbsp;&nbsp;:</p>
                        <p id="location">Location  &nbsp;&nbsp;:</p>
                        <p id="date">Date  &nbsp;&nbsp;:</p>
                        <p id="details">Detail  &nbsp;&nbsp;:</p>
                        <p id="price">Price  &nbsp;&nbsp;:</p>
                        <p id="people">จำนวนคนที่รับ  &nbsp;&nbsp;:</p>
                        <p id="hours">จำนวนชั่วโมงที่เรียน  &nbsp;&nbsp;:</p>
                        <p id></p>
                    </div>
                </div>
            </div>
            <!-- right -->
            <%- include('../includes/rightbar.ejs')%>
        </div>
    </main>

    <script>
      //ดึงข้อมูลจากโพสต์
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('post_id');
            console.log('Post ID:', postId);

            if (postId) {
                try {
                    const response = await fetch(`/post/${postId}`);
                    const postDataArray = await response.json();
                    console.log('Post Data:', postDataArray);

                    if (postDataArray.length > 0) {
                        const postData = postDataArray[0];
                        document.getElementById('tutorName').textContent += ` ${postData.tutor_name}`;
                        document.getElementById('date').textContent += ` ${new Date(postData.date).toISOString().split('T')[0]}`;
                        document.getElementById('tag').textContent += ` ${postData.tag}`;
                        document.getElementById('details').textContent += ` ${postData.details}`;
                        document.getElementById('location').textContent += ` ${postData.location}`;
                        document.getElementById('price').textContent += ` ${postData.price}`;
                        document.getElementById('people').textContent += ` ${postData.people}`;
                        document.getElementById('hours').textContent += ` ${postData.hours}`;
                        document.getElementById('profilePic').src = postData.profilePic ? postData.profilePic : './img/racc.jfif';

                        // Store postData for later use
                        window.postData = postData;

                        // Check if the number of people has reached the limit
                      if (postData.people >= postData.maxPeople) {
                          document.getElementById('joinButton').disabled = true;
                          document.getElementById('joinButton').textContent = "เต็มแล้ว";
                      }

                      } else {
                        console.error('No post data found');
                    }
                } catch (error) {
                    console.error('Error fetching post details:', error);
                }
            } else {
                console.error('No post_id found in the URL');
            }
        });

        async function joinGroup() {
    const postData = window.postData;

    if (postData.people < postData.maxPeople) {
        try {
            // Send request to join the group
            const response = await fetch(`/join/${postId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userId: 'user_id' }), // Replace 'yourUserId' with the actual user ID
            });

            if (response.ok) {
                alert('join successfully');
                postData.people += 1;
                document.getElementById('people').textContent = `จำนวนคนที่รับ: ${postData.people}`;

                // Disable button if the limit is reached
                if (postData.people >= postData.maxPeople) {
                    document.getElementById('joinButton').disabled = true;
                    document.getElementById('joinButton').textContent = "เต็มแล้ว";
                }

                // Send request to the post owner for approval
                await fetch(`/notifyOwner/${postData.ownerId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ postId: postData.id, userId: 'yourUserId' }), // Replace 'yourUserId' with the actual user ID
                });
            } else {
                alert('Error joining the group');
            }
        } catch (error) {
            console.error('Error sending join request:', error);
        }
    } else {
        alert('The group is already full');
        document.getElementById('joinButton').disabled = true;
        document.getElementById('joinButton').textContent = "เต็มแล้ว";
    }
}
    </script>
</body>
</html>
