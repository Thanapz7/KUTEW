<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="/css/home.css" />
    <title>Join Class</title>
  </head>
  <body>
    <!-- navbar -->
    <%- include('../includes/navbar.ejs')%>

    <!-- main -->
    <main>
      <div class="container">
        <!-- left -->
        <%- include('../includes/sidebar.ejs')%>
        <!-- middle -->
        <div class="middle">
            <form id="createPostForm" class="create-post" enctype="multipart/form-data">
            <div class="post">
              <div class="make-post">
                <div class="form-group">
                  <label>เขียนรายละเอียด :</label>
                  <textarea
                    name="details"
                    placeholder="กรุณากรอกรายละเอียด"
                  ></textarea>
                </div>
                <div class="form-group">
                  <label>เลือก Tag :</label>
                  <input type="text" name="tag" />
                </div>
                <div class="form-group">
                  <label>สถานที่สอน :</label>
                  <input type="text" name="location" />
                </div>
                <div class="form-group">
                  <label>เลือกวันที่สอน :</label>
                  <input type="date" name="date" />
                </div>
                <div class="form-group">
                  <label>ราคาที่สอน :</label>
                  <input type="text" name="price" id="price" />
                  <span id="price-error" class="error"></span>
                </div>
                <div class="form-group">
                  <label>จำนวนคนที่รับ :</label>
                  <input type="text" name="people" id="participants" />
                  <span id="participants-error" class="error"></span>
                </div>
                <div class="form-group">
                  <label>จำนวนชั่วโมงที่เรียน :</label>
                  <input type="text" name="hours" id="hours" />
                  <span id="hours-error" class="error"></span>
                </div>
                <div class="form-group">
                  <label>QR รับเงิน :</label>
                  <input type="file" name="QRcodePhoto" id="qr" accept="image/*" />
                  <span id="qr-error" class="error"></span>
                </div>
                <div class="btn-makepost">
                  <button type="submit" class="btn-post" onclick="validateFormPost(event)">Post</button> 
                  <button
                    type="button"
                    class="btn-allpost"
                    onclick="window.location.href='/allposts'"
                  >
                    ไปที่ Post ทั้งหมด
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
        <!-- right -->
        <%- include('../includes/rightbar.ejs')%>
      </div>
    </main>

    <script>
      document.getElementById("createPostForm").addEventListener("submit", function (event) {
        event.preventDefault();
      
        const formData = new FormData(this);
      
        fetch("/post/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            console.log("ได้รับการตอบกลับ:", response);
            if (response.ok) {
              alert("ทำการส่งแบบฟอร์มแล้ว");
              window.location.href = "/home";
            } else {
              console.error("การส่งล้มเหลว:", response);
              throw new Error("Submission failed");
            }
          })
          .catch((error) => {
            console.error("เกิดข้อผิดพลาด:", error);
            alert("การส่งข้อมูลล้มเหลว: " + error.message);
          });
      });
      async function fetchUserData() {
        try {
            const response = await fetch('/user/u');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const userData = await response.json();
            document.getElementById('user-name').textContent = userData.name;
        } catch (error) {
            console.error('Error fetching user data:', error);
            document.getElementById('user-name').textContent = 'Error loading name';
        }
    }

    // Call the function to fetch user data when the page loads
    window.onload = fetchUserData;

    function validateFormPost(event) {
      event.preventDefault();

      // Clear previous errors
      document.getElementById('price-error').textContent = '';
      document.getElementById('participants-error').textContent = '';
      document.getElementById('hours-error').textContent = '';
      document.getElementById('qr-error').textContent = '';

      let isValid = true;

      // Validate price
      const price = document.getElementById('price').value;
      if (isNaN(price)) {
          document.getElementById('price-error').textContent = 'กรุณากรอกเป็นตัวเลข';
          isValid = false;
      } else if (price > 500) {
          document.getElementById('price-error').textContent = 'ราคาต้องไม่เกิน 500 บาท';
          isValid = false;
      }

      // Validate participants
      const participants = document.getElementById('participants').value;
      if (isNaN(participants)) {
          document.getElementById('participants-error').textContent = 'กรุณากรอกเป็นตัวเลข';
          isValid = false;
      }

      // Validate hours
      const hours = document.getElementById('hours').value;
      if (isNaN(hours)) {
          document.getElementById('hours-error').textContent = 'กรุณากรอกเป็นตัวเลข';
          isValid = false;
      }

      // Validate QR file
      const qr = document.getElementById('qr').files[0];
      if (qr && !qr.type.startsWith('image/')) {
          document.getElementById('qr-error').textContent = 'อัพโหลดไฟล์รูปภาพเท่านั้น';
          isValid = false;
      }

      if (isValid) {
          // Submit the form or perform any other actions needed
          alert('Form submitted successfully!');
      }
  }

  document.getElementById('createPostForm').addEventListener('submit', validateForm);
    </script>
  </body>
</html>
